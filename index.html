<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Online Imposter Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --orange: #FFB74D;
      --coral: #FF8A65;
      --blue: #64B5F6;
      --teal: #4DB6AC;
      --lavender: #B39DDB;
      --dark-text: #333;
      --light-text: #fff;
      --light-bg: #f9f9f9;
      --shadow: 0 4px 8px rgba(0,0,0,0.1);
      --rounded: 12px;
    }
    
    body { 
      font-family: 'Poppins', sans-serif; 
      text-align: center; 
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, var(--blue) 0%, var(--teal) 100%);
      color: var(--dark-text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    h1, h2, h3 {
      color: var(--dark-text);
      margin-top: 0.5em;
    }
    
    h1 {
      font-size: 2.5em;
      background: -webkit-linear-gradient(var(--coral), var(--orange));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.3em;
    }
    
    input, button { 
      margin: 0.5em; 
      padding: 0.8em 1.2em; 
      font-size: 1em; 
      border: none;
      border-radius: var(--rounded);
      font-family: 'Poppins', sans-serif;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }
    
    input {
      background-color: rgba(255, 255, 255, 0.9);
      width: 80%;
      max-width: 300px;
    }
    
    input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(100, 181, 246, 0.5);
    }
    
    button {
      background-color: var(--coral);
      color: white;
      cursor: pointer;
      font-weight: 600;
      min-width: 120px;
    }
    
    button:hover {
      background-color: var(--orange);
      transform: translateY(-2px);
    }
    
    .hidden { 
      display: none; 
    }
    
    #lobbyCodeDisplay { 
      font-weight: bold; 
      color: var(--coral);
      font-size: 1.5em;
      letter-spacing: 2px;
    }
    
    ul { 
      list-style-type: none; 
      padding: 0; 
      margin: 1em auto;
      width: 90%;
      max-width: 500px;
    }
    
    li { 
      margin: 0.8em 0;
      padding: 0.8em;
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: var(--rounded);
      box-shadow: var(--shadow);
      transition: transform 0.2s ease;
    }
    
    li:hover {
      transform: translateY(-2px);
    }
    
    #voteList li {
      display: flex;
      align-items: center;
      padding: 0.5em 1em;
    }
    
    #voteList button {
      margin-right: 1em;
      background-color: var(--lavender);
      min-width: 100px;
      flex-shrink: 0;
    }
    
    #voteList button:hover {
      background-color: #9575cd;
    }
    
    .vote-answer-container {
      flex-grow: 1;
      text-align: left;
      display: flex;
      align-items: baseline;
      flex-wrap: wrap;
    }
    
    .vote-player-name {
      font-weight: 600;
      color: var(--coral);
      margin-right: 0.25em;
    }
    
    .voting-main-question {
      font-size: 1.2em;
      font-weight: 600;
      color: var(--coral);
      margin: 0.5em 0 1.5em 0;
      padding: 1em;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: var(--rounded);
      box-shadow: var(--shadow);
    }
    
    .answer-display { 
      color: #555; 
      font-style: italic; 
      margin-left: 0.25em;
      flex-grow: 1;
    }
    
    #home, #rules, #lobby, #questionPhase, #readAnswers, #mainReveal, #votingPhase, #postVoteWait, #revealPhase {
      background-color: rgba(255, 255, 255, 0.9);
      padding: 2em;
      border-radius: var(--rounded);
      box-shadow: var(--shadow);
      width: 90%;
      max-width: 600px;
      margin: 1em auto;
    }
    
    #playerQuestion, #mainQuestionDisplay {
      font-size: 1.3em;
      font-weight: 600;
      color: var(--coral);
      margin: 1em 0;
      padding: 1em;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: var(--rounded);
      box-shadow: var(--shadow);
    }
    
    #answerField {
      width: 90%;
      max-width: 400px;
    }
    
    #markReadyBtn {
      background-color: var(--blue);
    }
    
    #markReadyBtn:hover {
      background-color: #42a5f5;
    }
    
    #createBtn {
      background-color: var(--teal);
    }
    
    #createBtn:hover {
      background-color: #26a69a;
    }
    
    #joinBtn {
      background-color: var(--blue);
    }
    
    #joinBtn:hover {
      background-color: #42a5f5;
    }
    
    #startGameBtn, #revealMainBtn, #goToVotingBtn {
      background-color: var(--orange);
      margin-top: 1em;
      padding: 1em 2em;
    }
    
    #rulesBtn, #backHomeBtn {
      background-color: var(--lavender);
    }
    
    #rulesBtn:hover, #backHomeBtn:hover {
      background-color: #9575cd;
    }
    
    #restartGameBtn {
      background-color: var(--teal);
      margin-top: 1.5em;
      padding: 1em 2em;
      font-size: 1.1em;
    }
    
    #restartGameBtn:hover {
      background-color: #26a69a;
    }
    
    #mainQuestionInAnswers {
      font-size: 1.3em;
      font-weight: 600;
      color: var(--coral);
      margin: 1em 0;
      padding: 1em;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: var(--rounded);
      box-shadow: var(--shadow);
      display: none;
    }
    
    #waitForOthers, #postVoteWait {
      padding: 1em;
      margin: 1em 0;
      background-color: rgba(179, 157, 219, 0.3);
      border-radius: var(--rounded);
    }
    
    #postVoteWait {
      background-color: rgba(255, 255, 255, 0.9);
      box-shadow: var(--shadow);
    }
    
    #postVoteWait h2 {
      color: var(--teal);
    }
    
    #revealText p {
      padding: 0.5em;
      margin: 0.5em 0;
      border-radius: var(--rounded);
      background-color: rgba(255, 255, 255, 0.7);
    }
    
    #revealText strong {
      color: var(--coral);
    }
    
    #deckSelection {
      margin: 1.5em 0;
      padding: 1em;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: var(--rounded);
      box-shadow: var(--shadow);
    }
    
    .deck-options {
      display: flex;
      justify-content: center;
      gap: 0.8em;
      margin: 1em 0;
    }
    
    .deck-btn {
      background-color: var(--blue);
      padding: 0.8em 1.2em;
      border-radius: var(--rounded);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .deck-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .deck-btn.active {
      background-color: var(--teal);
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    #deckDescription {
      font-style: italic;
      color: var(--dark-text);
      margin-top: 0.5em;
    }
    
    .deck-info {
      margin-top: 1em;
      padding: 0.5em 1em;
      background-color: rgba(77, 182, 172, 0.2);
      border-radius: var(--rounded);
      display: inline-block;
    }
    
    @media (max-width: 600px) {
      body {
        padding: 1em;
      }
      
      h1 {
        font-size: 2em;
      }
      
      input, button {
        padding: 0.6em 1em;
      }
    }
  </style>
</head>
<body>
  <!-- HOME SCREEN -->
  <div id="home">
    <h1>Imposter Game</h1>
    <p><b>Create or Join a Lobby</b></p>
    <input id="nameInput" placeholder="Your Name">
    <br>
    <button id="createBtn">Create Lobby</button>
    <br>
    <input id="joinCodeInput" placeholder="Enter Lobby Code">
    <button id="joinBtn">Join Lobby</button>
    <br><br>
    <button id="rulesBtn">Rules</button>
  </div>

  <!-- RULES SCREEN -->
  <div id="rules" class="hidden">
    <h2>How to Play</h2>
    <p>
      1. One player creates a lobby and shares the code. Everyone else joins with that code.<br>
      2. The host starts the game once there are at least 3 players.<br>
      3. Each player gets a question. One random player is the Imposter and gets a slightly different question.<br>
      4. Everyone types their answer secretly. Once all are ready, everyone's answers are revealed.<br>
      5. Then the main question is revealed. Only the host's browser will read it aloud; everyone sees it on screen.<br>
      6. Vote on who you think the Imposter is. The results will show who was voted out, and if they were the Imposter.<br>
      7. Have fun deducing who is lying!
    </p>
    <p>
      <strong>Note:</strong> Answers are typed privately. The Imposter tries to blend in by giving an answer that fits the main question they <em>did not</em> actually see.
    </p>
    <button id="backHomeBtn">Back to Home</button>
  </div>

  <!-- LOBBY SCREEN -->
  <div id="lobby" class="hidden">
    <h2>Lobby Code: <span id="lobbyCodeDisplay"></span></h2>
    <h3>Players:</h3>
    <ul id="playerList"></ul>
    
    <div id="deckSelection" class="hidden">
      <h3>Select Question Deck:</h3>
      <div class="deck-options">
        <button id="numbersDeckBtn" class="deck-btn">Numbers</button>
        <button id="wordsDeckBtn" class="deck-btn">Words</button>
        <button id="mixedDeckBtn" class="deck-btn active">Mixed</button>
      </div>
      <p id="deckDescription">Mixed: Randomly selects between Numbers and Words decks each game</p>
    </div>
    
    <button id="startGameBtn" class="hidden">Start Game</button>
  </div>

  <!-- QUESTION PHASE -->
  <div id="questionPhase" class="hidden">
    <h2>Your Question</h2>
    <p id="playerQuestion"></p>
    <div id="answerContainer">
      <input id="answerField" placeholder="Type your answer..."/><br>
      <button id="markReadyBtn">I've Written My Answer</button>
    </div>
    <div id="waitForOthers" class="hidden">
      <p>Waiting for everyone else to finish...</p>
    </div>
  </div>

  <!-- READ ANSWERS -->
  <div id="readAnswers" class="hidden">
    <h2>Everyone's Answers</h2>
    <div id="mainQuestionInAnswers"></div>
    <ul id="answerList"></ul>
    <button id="revealMainBtn" class="hidden">Reveal Main Question</button>
    <button id="goToVotingBtn" class="hidden">Go to Voting</button>
  </div>

  <!-- MAIN REVEAL -->
  <div id="mainReveal" class="hidden">
    <h2>MAIN QUESTION</h2>
    <p id="mainQuestionDisplay"></p>
  </div>

  <!-- VOTING PHASE -->
  <div id="votingPhase" class="hidden">
    <h2>Vote for the Imposter</h2>
    <p>Choose who you think received a different question:</p>
    <ul id="voteList"></ul>
  </div>

  <!-- POST-VOTE WAIT SCREEN (LOCAL ONLY) -->
  <div id="postVoteWait" class="hidden">
    <h2>Thanks for voting!</h2>
    <p>Waiting for everyone else to finish...</p>
  </div>

  <!-- REVEAL PHASE -->
  <div id="revealPhase" class="hidden">
    <h2>Imposter Reveal</h2>
    <div id="revealText">Calculating votes...</div>
    <button id="restartGameBtn" class="hidden">Start New Game</button>
  </div>

  <!-- Single-File JS w/ Firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js';
    import {
      getDatabase, ref, set, update, get, onValue, off
    } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyA3JrnVvOPto_aQ95MasBEd68-du6gJmCA",
      authDomain: "online-imposter.firebaseapp.com",
      databaseURL: "https://online-imposter-default-rtdb.firebaseio.com",
      projectId: "online-imposter",
      storageBucket: "online-imposter.firebasestorage.app",
      messagingSenderId: "925601269436",
      appId: "1:925601269436:web:661f6b53a754b5ccbc32b9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let playerName = "";
    let lobbyCode = "";
    let isHost = false;
    let questionPair = null;
    let imposter = "";
    let allQuestionsRef = null;

    // Question pairs for the game
    const questionDecks = {
      numbers: [
        { q1: "How many times have you been horseback riding in your life?", q2: "How many sleepaway camps have you been to?" },
        { q1: "How many books do you read in a typical year?", q2: "How many movies do you watch in a typical month?" },
        { q1: "How many hours of sleep do you typically get each night?", q2: "How many cups of coffee do you drink in a typical day?" },
        { q1: "How many countries have you visited?", q2: "How many states or provinces have you visited in your home country?" },
        { q1: "How many languages do you speak?", q2: "How many instruments can you play?" },
        { q1: "How many pillows do you sleep with?", q2: "How many pairs of shoes do you own?" },
        { q1: "How many pets have you had in your lifetime?", q2: "How many houseplants do you currently have?" },
        { q1: "How many times have you moved homes in your life?", q2: "How many schools did you attend growing up?" },
        { q1: "What's your ideal number of children to have?", q2: "How many cousins do you have?" },
        { q1: "How many streaming services do you subscribe to?", q2: "How many apps do you use daily on your phone?" },
        { q1: "How many hours per day do you spend on your phone?", q2: "How many times do you check social media daily?" },
        { q1: "How many times have you been to a live concert?", q2: "How many musical instruments have you tried playing?" },
        { q1: "How many close friends would you say you have?", q2: "How many people do you regularly keep in touch with?" },
        { q1: "How many hours do you work per week?", q2: "How many days of vacation do you take per year?" },
        { q1: "How many alarms do you set to wake up?", q2: "How many times do you hit snooze each morning?" },
        { q1: "How many cups of water do you drink daily?", q2: "How many caffeinated beverages do you have in a typical day?" },
        { q1: "How many times have you been on an airplane?", q2: "How many road trips have you taken?" },
        { q1: "How many movies do you watch in a typical month?", q2: "How many TV shows are you currently following?" },
        { q1: "How many photos would you guess are on your phone right now?", q2: "How many photos would you say you take in a typical week?" },
        { q1: "How many times per week do you eat out?", q2: "How many times per week do you cook at home?" },
        { q1: "How many pieces of technology do you own?", q2: "How many subscriptions do you pay for monthly?" },
        { q1: "How many minutes is your daily commute?", q2: "How many miles/kilometers do you live from your workplace/school?" },
        { q1: "How many times have you broken a bone?", q2: "How many times have you been to a hospital?" },
        { q1: "How many weddings have you attended?", q2: "How many birthday parties do you go to annually?" },
        { q1: "How many pairs of jeans do you own?", q2: "How many shirts are in your closet?" },
        { q1: "How many times a week do you exercise?", q2: "How many different types of exercise do you do regularly?" },
        { q1: "How many hours do you spend outdoors in a typical week?", q2: "How many parks or natural areas have you visited in the last year?" },
        { q1: "How many items are on your bucket list?", q2: "How many goals have you set for this year?" },
        { q1: "How many siblings do you have?", q2: "How many people live in your household?" },
        { q1: "How many days per week do you eat breakfast?", q2: "How many times do you snack between meals daily?" },
        { q1: "How many languages would you like to learn?", q2: "How many languages can you understand at least partially?" },
        { q1: "How many hours do you spend reading per week?", q2: "How many books are on your 'to read' list?" },
        { q1: "How many minutes do you spend brushing your teeth?", q2: "How many times have you been to the dentist in the past 2 years?" },
        { q1: "How many best friends have you had in your life?", q2: "How many of your childhood friends are you still in contact with?" },
        { q1: "How many hobbies would you say you have?", q2: "How many hours per week do you spend on hobbies?" },
        { q1: "How many steps do you take on an average day?", q2: "How many minutes do you typically walk daily?" },
        { q1: "How many months have you lived at your current address?", q2: "How many times have you redecorated your living space?" },
        { q1: "How many different jobs have you had?", q2: "How many career fields have you worked in?" },
        { q1: "How many emails do you receive daily?", q2: "How many unread notifications do you currently have?" },
        { q1: "How many tabs do you typically have open on your browser?", q2: "How many apps do you have installed on your phone?" },
        { q1: "How many times do you hit snooze in the morning?", q2: "How many hours of sleep do you need to feel well-rested?" },
        { q1: "How many tattoos do you have?", q2: "How many piercings do you have?" },
        { q1: "How many glasses of water do you drink daily?", q2: "How many sodas do you drink in a typical week?" },
        { q1: "How many times do you brush your teeth daily?", q2: "How many times do you floss per week?" },
        { q1: "How many times have you voted in an election?", q2: "How many times have you participated in a protest or rally?" },
        { q1: "How many times have you been stung by a bee?", q2: "How many mosquito bites do you typically get each summer?" },
        { q1: "How many streaming services do you currently subscribe to?", q2: "How many hours of TV/movies do you watch weekly?" },
        { q1: "How many video games have you completed?", q2: "How many board games do you own?" },
        { q1: "How many times have you lost your cell phone?", q2: "How many phone screens have you cracked?" }
      ],
      words: [
        { q1: "What's your favorite board game?", q2: "What's your favorite card game?" },
        { q1: "What's the most interesting place you've traveled to?", q2: "What's your dream vacation destination?" },
        { q1: "What was your first job?", q2: "What was your worst job?" },
        { q1: "What's your favorite childhood memory?", q2: "What's the most embarrassing thing that happened to you as a child?" },
        { q1: "If you could have dinner with any historical figure, who would it be?", q2: "If you could have any fictional character as a best friend, who would it be?" },
        { q1: "What's the best gift you've ever received?", q2: "What's the best gift you've ever given someone?" },
        { q1: "What's your favorite season and why?", q2: "What's your favorite holiday and why?" },
        { q1: "What's your go-to karaoke song?", q2: "What artist have you seen perform live most often?" },
        { q1: "What's your favorite type of cuisine?", q2: "What's your favorite dessert?" },
        { q1: "What hobby would you like to try but haven't yet?", q2: "What skill would you like to master?" },
        { q1: "What's your favorite movie of all time?", q2: "What TV show could you watch over and over again?" },
        { q1: "What's your ideal weekend activity?", q2: "What's your favorite way to relax after a long day?" },
        { q1: "What's your favorite book?", q2: "Who is your favorite author?" },
        { q1: "What's the best piece of advice you've ever received?", q2: "What's a lesson you had to learn the hard way?" },
        { q1: "What's your favorite ice cream flavor?", q2: "What's your go-to comfort food?" },
        { q1: "What's a superpower you wish you had?", q2: "If you were an animal, what would you be and why?" },
        { q1: "What's your favorite childhood toy?", q2: "What's your favorite childhood cartoon?" },
        { q1: "What's your dream car?", q2: "What's your preferred method of transportation?" },
        { q1: "What's the most beautiful place you've ever seen?", q2: "What natural wonder would you most like to visit?" },
        { q1: "What subject were you best at in school?", q2: "What subject did you struggle with the most?" },
        { q1: "What's your favorite genre of music?", q2: "Who is your favorite musical artist?" },
        { q1: "What's your favorite quote or saying?", q2: "What's a phrase or saying you use too often?" },
        { q1: "What's your idea of a perfect day?", q2: "What's your favorite time of day?" },
        { q1: "What's your favorite sport to watch?", q2: "What's your favorite sport to play?" },
        { q1: "What's your favorite family tradition?", q2: "What's a tradition you'd like to start?" },
        { q1: "What's the best concert you've ever attended?", q2: "What artist would you love to see perform live?" },
        { q1: "What's your favorite thing about your hometown?", q2: "Where would you like to live someday?" },
        { q1: "What's your favorite thing about your job/studies?", q2: "What would be your dream job?" },
        { q1: "What's a fear you've overcome?", q2: "What's something you're still afraid of?" },
        { q1: "What's your favorite type of weather?", q2: "What's your least favorite season?" },
        { q1: "What's your favorite home-cooked meal?", q2: "What's your signature dish to cook?" },
        { q1: "What's the best restaurant you've ever been to?", q2: "What type of restaurant do you visit most often?" },
        { q1: "What's your favorite clothing item you own?", q2: "What's your go-to outfit?" },
        { q1: "What was your favorite subject in school?", q2: "What subject do you wish you had paid more attention to?" },
        { q1: "What's your favorite holiday tradition?", q2: "What's your favorite holiday food?" },
        { q1: "What's your favorite outdoor activity?", q2: "What's your favorite indoor activity for a rainy day?" },
        { q1: "What's the best advice you've ever received?", q2: "What advice would you give your younger self?" },
        { q1: "What's the most useful thing you own?", q2: "What's something you own that has sentimental value?" },
        { q1: "What app on your phone do you use the most?", q2: "What website do you visit most frequently?" },
        { q1: "What's your favorite podcast?", q2: "What's your favorite YouTube channel?" },
        { q1: "What's the best view you've ever seen?", q2: "What's a place you find peaceful?" },
        { q1: "What smell brings back the strongest memories for you?", q2: "What's your favorite scent?" },
        { q1: "What fictional world would you most like to visit?", q2: "What fictional character do you most relate to?" },
        { q1: "What's the best compliment you've ever received?", q2: "What's a quality you admire in others?" },
        { q1: "What's a small thing that makes your day better?", q2: "What's a minor inconvenience that always annoys you?" },
        { q1: "What's the last book you read?", q2: "What book had the biggest impact on you?" },
        { q1: "What's your favorite breakfast food?", q2: "What's the strangest food combination you enjoy?" },
        { q1: "What's your favorite holiday?", q2: "What's your favorite family tradition?" },
        { q1: "What's the first thing you do when you wake up?", q2: "What's your bedtime routine?" },
        { q1: "What's a cause you're passionate about?", q2: "What's something you'd like to change about the world?" }
      ]
    };
    
    // Track the selected question deck
    let selectedDeck = "mixed";

    // DOM references
    const homeDiv       = document.getElementById('home');
    const rulesDiv      = document.getElementById('rules');
    const lobbyDiv      = document.getElementById('lobby');
    const questionDiv   = document.getElementById('questionPhase');
    const answersDiv    = document.getElementById('readAnswers');
    const mainDiv       = document.getElementById('mainReveal');
    const votingDiv     = document.getElementById('votingPhase');
    const postVoteDiv   = document.getElementById('postVoteWait');
    const revealDiv     = document.getElementById('revealPhase');

    function showDiv(divID) {
      [
        homeDiv, rulesDiv, lobbyDiv,
        questionDiv, answersDiv, mainDiv,
        votingDiv, postVoteDiv, revealDiv
      ].forEach(d => d.classList.add('hidden'));
      document.getElementById(divID).classList.remove('hidden');
    }

    // Home screen
    document.getElementById('createBtn').onclick = createLobby;
    document.getElementById('joinBtn').onclick   = joinLobby;
    document.getElementById('rulesBtn').onclick  = () => showDiv('rules');
    document.getElementById('backHomeBtn').onclick = () => showDiv('home');

    async function createLobby() {
      playerName = document.getElementById("nameInput").value.trim();
      if (!playerName) {
        alert("Please enter a name.");
        return;
      }
      lobbyCode = Math.random().toString(36).substring(2, 7).toUpperCase();
      isHost = true;

      try {
        await set(ref(db, `lobbies/${lobbyCode}`), {
          players: { [playerName]: true },
          host: playerName,
          phase: "lobby",
          questionDeck: selectedDeck  // Set the initial deck selection
        });
        enterLobby();
      } catch (error) {
        alert("Error creating lobby: " + error.message);
      }
    }

    async function joinLobby() {
      playerName = document.getElementById("nameInput").value.trim();
      lobbyCode  = document.getElementById("joinCodeInput").value.trim().toUpperCase();
      if (!playerName || !lobbyCode) {
        alert("Please enter name and lobby code.");
        return;
      }

      try {
        const lobbyRef = ref(db, `lobbies/${lobbyCode}`);
        const snapshot = await get(lobbyRef);

        if (!snapshot.exists()) {
          alert("Lobby not found.");
          return;
        }

        const lobbyData = snapshot.val();
        
        // Check if name is already taken
        if (lobbyData.players && lobbyData.players[playerName]) {
          alert("That name is already taken in this lobby.");
          return;
        }

        isHost = (lobbyData.host === playerName);
        await update(ref(db, `lobbies/${lobbyCode}/players`), {
          [playerName]: true
        });
        
        enterLobby();
      } catch (error) {
        alert("Error joining lobby: " + error.message);
      }
    }

    function enterLobby() {
      showDiv("lobby");
      document.getElementById("lobbyCodeDisplay").innerText = lobbyCode;

      // Clear any existing answer data in the UI
      document.getElementById("answerList").innerHTML = "";
      document.getElementById("mainQuestionInAnswers").style.display = "none";
      document.getElementById("voteList").innerHTML = "";
      
      // Clear any existing vote data
      hasVoted = false;

      const playerList = document.getElementById("playerList");
      const playersRef = ref(db, `lobbies/${lobbyCode}/players`);
      
      onValue(playersRef, snapshot => {
        playerList.innerHTML = '';
        if (snapshot.exists()) {
          const players = Object.keys(snapshot.val());
          players.forEach(p => {
            const li = document.createElement("li");
            li.innerText = p + (p === playerName ? " (You)" : "");
            playerList.appendChild(li);
          });
        }
      });

      const startBtn = document.getElementById("startGameBtn");
      const deckSelectionDiv = document.getElementById("deckSelection");
      
      if (isHost) {
        startBtn.classList.remove("hidden");
        deckSelectionDiv.classList.remove("hidden");
        startBtn.onclick = startGame;
        
        // Setup deck selection buttons
        document.getElementById("numbersDeckBtn").onclick = () => selectDeck("numbers");
        document.getElementById("wordsDeckBtn").onclick = () => selectDeck("words");
        document.getElementById("mixedDeckBtn").onclick = () => selectDeck("mixed");
        
        // Set the initial active deck
        selectDeck(selectedDeck);
      } else {
        startBtn.classList.add("hidden");
        deckSelectionDiv.classList.add("hidden");
      }

      listenForPhaseChange();
    }
    
    async function selectDeck(deckName) {
      selectedDeck = deckName;
      
      // Update UI
      document.querySelectorAll(".deck-btn").forEach(btn => {
        btn.classList.remove("active");
      });
      
      document.getElementById(`${deckName}DeckBtn`).classList.add("active");
      
      // Update description
      const description = document.getElementById("deckDescription");
      switch(deckName) {
        case "numbers":
          description.textContent = "Numbers: Questions about quantities and numerical values";
          break;
        case "words":
          description.textContent = "Words: Questions about preferences and experiences";
          break;
        case "mixed":
          description.textContent = "Mixed: Randomly selects between Numbers and Words decks each game";
          break;
      }
      
      // If host, update the database
      if (isHost) {
        try {
          await update(ref(db, `lobbies/${lobbyCode}`), {
            questionDeck: deckName
          });
        } catch (error) {
          console.error("Error updating question deck:", error);
        }
      }
    }

    async function startGame() {
      try {
        const snap = await get(ref(db, `lobbies/${lobbyCode}/players`));
        if (!snap.exists()) {
          alert("Error: No players found.");
          return;
        }
        
        const players = Object.keys(snap.val() || {});

        if (players.length < 3) {
          alert('You need at least 3 players to start!');
          return;
        }

        // Pick a random imposter
        imposter = players[Math.floor(Math.random() * players.length)];
        
        // Get the selected question deck
        let deckToUse = selectedDeck;
        
        // If mixed is selected, randomly choose between numbers and words
        if (selectedDeck === "mixed") {
          deckToUse = Math.random() < 0.5 ? "numbers" : "words";
        }
        
        const deckQuestions = questionDecks[deckToUse];
        
        // Select a random question pair from the selected deck
        const randomQuestionIndex = Math.floor(Math.random() * deckQuestions.length);
        const selectedQuestionPair = deckQuestions[randomQuestionIndex];
        
        // Randomly decide which question is the main and which is the imposter question
        const isFirstQuestionMain = Math.random() >= 0.5;
        
        const mainQuestion = isFirstQuestionMain ? selectedQuestionPair.q1 : selectedQuestionPair.q2;
        const imposterQuestion = isFirstQuestionMain ? selectedQuestionPair.q2 : selectedQuestionPair.q1;
        
        // First, clear any existing question data
        await set(ref(db, `lobbies/${lobbyCode}/questions`), null);
        
        // Then, store the fresh questions and imposter for the new game
        await update(ref(db, `lobbies/${lobbyCode}`), {
          mainQuestion: mainQuestion,
          imposterQuestion: imposterQuestion,
          imposter: imposter,
          questionIndex: randomQuestionIndex,
          questionDeck: selectedDeck,
          actualDeckUsed: deckToUse,
          isFirstQuestionMain: isFirstQuestionMain,
          mainQuestionRevealed: false
        });

        // Assign questions to each player
        const questionsData = {};
        for (const p of players) {
          const q = (p === imposter) ? imposterQuestion : mainQuestion;
          questionsData[p] = {
            question: q,
            answer: "",
            ready: false,
            vote: null
          };
        }
        
        // Set all questions at once to avoid race conditions
        await set(ref(db, `lobbies/${lobbyCode}/questions`), questionsData);

        // Move to question phase
        await update(ref(db, `lobbies/${lobbyCode}`), { phase: "questionPhase" });
      } catch (error) {
        alert("Error starting game: " + error.message);
      }
    }

    function listenForPhaseChange() {
      const phaseRef = ref(db, `lobbies/${lobbyCode}/phase`);
      onValue(phaseRef, snapshot => {
        if (!snapshot.exists()) return;
        
        const phase = snapshot.val();
        
        // Clear any existing listeners when changing phases
        if (allQuestionsRef) {
          off(allQuestionsRef);
          allQuestionsRef = null;
        }

        if (phase === "lobby") showDiv("lobby");
        else if (phase === "questionPhase") {
          showDiv("questionPhase");
          loadQuestion();
        }
        else if (phase === "readAnswers") {
          showDiv("readAnswers");
          loadAnswers();
        }
        else if (phase === "mainReveal") {
          showDiv("mainReveal");
          loadMainReveal();
        }
        else if (phase === "votingPhase") {
          showDiv("votingPhase");
          loadVoting();
        }
        else if (phase === "revealPhase") {
          showDiv("revealPhase");
          loadReveal();
        }
      });
      
      // Listen for question deck changes (host only)
      if (isHost) {
        const deckRef = ref(db, `lobbies/${lobbyCode}/questionDeck`);
        onValue(deckRef, snapshot => {
          if (!snapshot.exists()) return;
          
          const remoteDeck = snapshot.val();
          if (remoteDeck && remoteDeck !== selectedDeck) {
            selectedDeck = remoteDeck;
            selectDeck(selectedDeck);
          }
        });
      }
      
      // Also listen for the main question revealed state
      const mainQuestionRevealedRef = ref(db, `lobbies/${lobbyCode}/mainQuestionRevealed`);
      onValue(mainQuestionRevealedRef, async snapshot => {
        if (!snapshot.exists() || !snapshot.val()) return;
        
        // Only update if we're in the answers phase and the question is newly revealed
        const phaseSnap = await get(ref(db, `lobbies/${lobbyCode}/phase`));
        if (phaseSnap.exists() && phaseSnap.val() === "readAnswers") {
          const gameDataRef = ref(db, `lobbies/${lobbyCode}`);
          const gameDataSnap = await get(gameDataRef);
          
          if (gameDataSnap.exists() && gameDataSnap.val().mainQuestion) {
            showMainQuestion(gameDataSnap.val().mainQuestion);
          }
        }
      });
    }

    // Question Phase
    document.getElementById("markReadyBtn").onclick = markReady;

    async function loadQuestion() {
      try {
        const myQuestionRef = ref(db, `lobbies/${lobbyCode}/questions/${playerName}`);
        const qSnap = await get(myQuestionRef);
        
        if (!qSnap.exists()) {
          console.error("Question not found for player");
          return;
        }

        const questionObj = qSnap.val();
        document.getElementById("playerQuestion").innerText = questionObj.question;
        
        if (questionObj.ready) {
          // Already submitted an answer
          document.getElementById("answerContainer").classList.add("hidden");
          document.getElementById("waitForOthers").classList.remove("hidden");
        } else {
          // Need to submit an answer
          document.getElementById("answerContainer").classList.remove("hidden");
          document.getElementById("waitForOthers").classList.add("hidden");
          document.getElementById("answerField").value = questionObj.answer || "";
        }

        // Setup listener to check if all players are ready
        setupAllReadyListener();
      } catch (error) {
        console.error("Error loading question:", error);
      }
    }

    function setupAllReadyListener() {
      allQuestionsRef = ref(db, `lobbies/${lobbyCode}/questions`);
      onValue(allQuestionsRef, snapshot => {
        if (!snapshot.exists()) return;
        
        const questionData = snapshot.val();
        const allReady = Object.values(questionData).every(p => p.ready);
        
        if (allReady) {
          // Everyone is ready, move to next phase
          update(ref(db, `lobbies/${lobbyCode}`), { phase: "readAnswers" });
        }
      });
    }

    async function markReady() {
      const inputEl = document.getElementById("answerField");
      const answer = inputEl.value.trim();
      if (!answer) {
        alert("Please type an answer!");
        return;
      }

      try {
        // Submit to DB
        await update(ref(db, `lobbies/${lobbyCode}/questions/${playerName}`), {
          ready: true,
          answer: answer
        });

        // Hide input, show waiting text
        document.getElementById("answerContainer").classList.add("hidden");
        document.getElementById("waitForOthers").classList.remove("hidden");
      } catch (error) {
        alert("Error submitting answer: " + error.message);
      }
    }

    // Read Answers
    document.getElementById("revealMainBtn").onclick = () => {
      if (isHost) {
        revealMainQuestion();
      }
    };

    async function revealMainQuestion() {
      try {
        const gameDataRef = ref(db, `lobbies/${lobbyCode}`);
        const snapshot = await get(gameDataRef);
        
        if (!snapshot.exists()) {
          console.error("Game data not found");
          return;
        }
        
        const gameData = snapshot.val();
        
        // Update the Firebase state to indicate the main question is revealed
        // This will trigger the state change for all connected players
        await update(ref(db, `lobbies/${lobbyCode}`), { 
          mainQuestionRevealed: true 
        });
        
        // Update the UI
        showMainQuestion(gameData.mainQuestion);
        
        if (isHost && gameData.mainQuestion) {
          speak(`The main question was: ${gameData.mainQuestion}`);
        }
      } catch (error) {
        console.error("Error revealing main question:", error);
      }
    }

    function showMainQuestion(question) {
      const mainQuestionEl = document.getElementById("mainQuestionInAnswers");
      mainQuestionEl.innerText = `Main Question: ${question}`;
      mainQuestionEl.style.display = "block";
      
      document.getElementById("revealMainBtn").classList.add("hidden");
      if (isHost) {
        document.getElementById("goToVotingBtn").classList.remove("hidden");
      }
    }

    async function loadAnswers() {
      try {
        const ansListEl = document.getElementById("answerList");
        ansListEl.innerHTML = "";
        
        // Reset the main question display
        const mainQuestionEl = document.getElementById("mainQuestionInAnswers");
        mainQuestionEl.innerText = "";
        mainQuestionEl.style.display = "none";
        
        const gameDataRef = ref(db, `lobbies/${lobbyCode}`);
        const gameDataSnap = await get(gameDataRef);
        if (gameDataSnap.exists()) {
          const gameData = gameDataSnap.val();
          
          // If the main question is already revealed, show it
          if (gameData.mainQuestionRevealed && gameData.mainQuestion) {
            showMainQuestion(gameData.mainQuestion);
          }
        }
        
        const qSnap = await get(ref(db, `lobbies/${lobbyCode}/questions`));
        if (!qSnap.exists()) {
          console.error("No answers found");
          return;
        }

        const allQs = qSnap.val();
        
        // Create a new answer list, ensuring only one entry per player
        const playerList = document.getElementById("playerList").querySelectorAll("li");
        const currentPlayers = Array.from(playerList).map(li => li.textContent.replace(" (You)", ""));
        
        // Only show answers for players currently in the game
        for (const pName of currentPlayers) {
          if (allQs[pName] && allQs[pName].answer) {
            const li = document.createElement("li");
            li.textContent = `${pName}: ${allQs[pName].answer}`;
            ansListEl.appendChild(li);
          }
        }

        // Only host sees the Reveal Main button if it's not already revealed
        const revealBtn = document.getElementById("revealMainBtn");
        const goToVotingBtn = document.getElementById("goToVotingBtn");
        
        const mainQuestionRevealed = gameDataSnap.exists() && gameDataSnap.val().mainQuestionRevealed;
        
        if (isHost) {
          if (!mainQuestionRevealed) {
            revealBtn.classList.remove("hidden");
            goToVotingBtn.classList.add("hidden");
          } else {
            revealBtn.classList.add("hidden");
            goToVotingBtn.classList.remove("hidden");
          }
        } else {
          revealBtn.classList.add("hidden");
          goToVotingBtn.classList.add("hidden");
        }
      } catch (error) {
        console.error("Error loading answers:", error);
      }
    }

    // Main Reveal
    document.getElementById("goToVotingBtn").onclick = () => {
      if (isHost) {
        update(ref(db, `lobbies/${lobbyCode}`), { phase: "votingPhase" });
      }
    };

    async function loadMainReveal() {
      try {
        const gameDataRef = ref(db, `lobbies/${lobbyCode}`);
        const snapshot = await get(gameDataRef);
        
        if (!snapshot.exists()) {
          console.error("Game data not found");
          return;
        }
        
        const gameData = snapshot.val();
        document.getElementById("mainQuestionDisplay").innerText = gameData.mainQuestion;
        
        if (isHost && gameData.mainQuestion) {
          speak(`The main question was: ${gameData.mainQuestion}`);
        }
      } catch (error) {
        console.error("Error loading main reveal:", error);
      }
    }

    function speak(text) {
      if ('speechSynthesis' in window) {
        const msg = new SpeechSynthesisUtterance(text);
        window.speechSynthesis.speak(msg);
      }
    }

    // Voting
    let hasVoted = false;
    
    async function loadVoting() {
      try {
        const list = document.getElementById("voteList");
        list.innerHTML = "";
        hasVoted = false;
    
        const playersSnap = await get(ref(db, `lobbies/${lobbyCode}/players`));
        if (!playersSnap.exists()) {
          console.error("No players found");
          return;
        }
        
        const playerNames = Object.keys(playersSnap.val());
    
        // Get all player answers for the current game
        const answersSnap = await get(ref(db, `lobbies/${lobbyCode}/questions`));
        if (!answersSnap.exists()) {
          console.error("No answers found");
          return;
        }
        const answerData = answersSnap.val();
        
        // Get the main question for display at the top
        const gameDataRef = ref(db, `lobbies/${lobbyCode}`);
        const gameDataSnap = await get(gameDataRef);
        
        // Clear any existing main question display
        const existingMainQuestion = document.querySelector(".voting-main-question");
        if (existingMainQuestion) {
          existingMainQuestion.remove();
        }
        
        if (gameDataSnap.exists() && gameDataSnap.val().mainQuestion) {
          // Add the main question at the top of the voting page
          const mainQuestionDiv = document.createElement("div");
          mainQuestionDiv.className = "voting-main-question";
          mainQuestionDiv.textContent = `Main Question: ${gameDataSnap.val().mainQuestion}`;
          list.parentNode.insertBefore(mainQuestionDiv, list);
        }
    
        // Check if player has already voted
        const myVoteSnap = await get(ref(db, `lobbies/${lobbyCode}/questions/${playerName}/vote`));
        if (myVoteSnap.exists() && myVoteSnap.val()) {
          hasVoted = true;
          showDiv("postVoteWait");
          setupAllVotedListener();
          return;
        }
    
        // Create voting buttons for all players except self
        playerNames.forEach(p => {
          if (p !== playerName && answerData[p] && answerData[p].answer) {
            const li = document.createElement("li");
            const playerAnswer = answerData[p].answer;
            
            const btn = document.createElement("button");
            btn.textContent = `Vote ${p}`;
            btn.onclick = () => submitVote(p);
            
            const answerContainer = document.createElement("div");
            answerContainer.className = "vote-answer-container";
            
            const nameSpan = document.createElement("span");
            nameSpan.className = "vote-player-name";
            nameSpan.textContent = p;
            
            const answerSpan = document.createElement("span");
            answerSpan.className = "answer-display";
            answerSpan.textContent = playerAnswer;
            
            li.appendChild(btn);
            answerContainer.appendChild(nameSpan);
            answerContainer.appendChild(document.createTextNode(": "));
            answerContainer.appendChild(answerSpan);
            li.appendChild(answerContainer);
            
            list.appendChild(li);
          }
        });
      } catch (error) {
        console.error("Error loading voting:", error);
      }
    }

    async function submitVote(votedPlayer) {
      if (hasVoted) return;
      hasVoted = true;

      try {
        await update(ref(db, `lobbies/${lobbyCode}/questions/${playerName}`), { vote: votedPlayer });
        showDiv("postVoteWait");
        setupAllVotedListener();
      } catch (error) {
        console.error("Error submitting vote:", error);
        hasVoted = false;
      }
    }

    function setupAllVotedListener() {
      allQuestionsRef = ref(db, `lobbies/${lobbyCode}/questions`);
      onValue(allQuestionsRef, snapshot => {
        if (!snapshot.exists()) return;
        
        const data = snapshot.val();
        const allVoted = Object.values(data).every(x => x.vote);
        
        if (allVoted) {
          update(ref(db, `lobbies/${lobbyCode}`), { phase: "revealPhase" });
        }
      });
    }

    // Restart Game
    document.getElementById("restartGameBtn").onclick = restartGame;

    async function restartGame() {
      if (!isHost) return;
      
      try {
        // Get the current players before reset
        const playersSnapshot = await get(ref(db, `lobbies/${lobbyCode}/players`));
        if (!playersSnapshot.exists()) {
          console.error("No players found for restart");
          return;
        }
        
        // Get the current question deck information
        const gameDataRef = ref(db, `lobbies/${lobbyCode}`);
        const gameDataSnap = await get(gameDataRef);
        const currentDeck = gameDataSnap.exists() && gameDataSnap.val().questionDeck ? 
          gameDataSnap.val().questionDeck : selectedDeck;
        
        const players = playersSnapshot.val();
        
        // Completely reset the lobby, but keep the host, code and selected deck
        await set(ref(db, `lobbies/${lobbyCode}`), {
          players: players,       // Keep the same players
          host: playerName,       // Keep the same host
          phase: "lobby",         // Go back to lobby phase
          questionDeck: currentDeck  // Keep the current deck selection
        });
        
        // Set the local deck selection
        selectedDeck = currentDeck;
        
        // Go back to lobby
        enterLobby();
      } catch (error) {
        console.error("Error restarting game:", error);
        alert("Error restarting game: " + error.message);
      }
    }

    // Reveal
    async function loadReveal() {
      try {
        const revealEl = document.getElementById("revealText");
        revealEl.innerHTML = "Calculating votes...";
    
        // Get game data to know who the imposter was
        const gameDataRef = ref(db, `lobbies/${lobbyCode}`);
        const gameDataSnap = await get(gameDataRef);
        
        if (!gameDataSnap.exists()) {
          revealEl.innerHTML = "Game data not found!";
          return;
        }
        
        const gameData = gameDataSnap.val();
        imposter = gameData.imposter;
    
        // Get voting data
        const qRef = ref(db, `lobbies/${lobbyCode}/questions`);
        const qSnap = await get(qRef);
        
        if (!qSnap.exists()) {
          revealEl.innerHTML = "No question data found!";
          return;
        }
        
        const qData = qSnap.val();
        const votes = {};
        const votedFor = {};
    
        for (const [pName, obj] of Object.entries(qData)) {
          const v = obj.vote;
          if (!v) continue;
          if (!votes[v]) votes[v] = 0;
          votes[v]++;
          if (!votedFor[v]) votedFor[v] = [];
          votedFor[v].push(pName);
        }
    
        if (Object.keys(votes).length === 0) {
          revealEl.innerHTML = "No votes received!";
          return;
        }
    
        let html = "<h3>Voting Results:</h3>";
        for (const [player, count] of Object.entries(votes)) {
          const whoVoted = votedFor[player].join(", ");
          html += `<p>${player}: ${count} vote(s) - Voted by: ${whoVoted}</p>`;
        }
    
        // Sort by vote count, highest first
        const sorted = Object.entries(votes).sort((a, b) => b[1] - a[1]);
        
        // Check for a tie
        const highestVotes = sorted[0][1];
        const tiedPlayers = sorted.filter(([_, count]) => count === highestVotes).map(([name, _]) => name);
        
        let resultText;
        let voteCorrect;
        
        if (tiedPlayers.length > 1) {
          // There's a tie
          const imposterInTie = tiedPlayers.includes(imposter);
          resultText = `There was a tie between ${tiedPlayers.join(", ")}`;
          voteCorrect = imposterInTie ? 
            `The imposter was among the tied players ` : 
            `The imposter was not among the tied players `;
        } else {
          // No tie, single player with highest votes
          const topVoted = sorted[0][0];
          const correct = (topVoted === imposter);
          resultText = `${topVoted} was voted out`;
          voteCorrect = correct ? 
            `They were the imposter ` : 
            `They were not the imposter `;
        }
        
        html += `<p><strong>${resultText}.</strong> ${voteCorrect}</p>`;
        html += `<p>The imposter was <strong>${imposter}</strong>, and their question was: "${gameData.imposterQuestion}"</p>`;
        
        // Add deck information
        const deckName = gameData.questionDeck || "mixed";
        let deckDisplayName;
        
        if (deckName === "mixed" && gameData.actualDeckUsed) {
          // For mixed, show which deck was actually used
          const actualDeckUsed = gameData.actualDeckUsed;
          deckDisplayName = `Mixed (${actualDeckUsed.charAt(0).toUpperCase() + actualDeckUsed.slice(1)})`;
        } else {
          deckDisplayName = deckName.charAt(0).toUpperCase() + deckName.slice(1);
        }
        
        html += `<p class="deck-info">Question Deck: <strong>${deckDisplayName}</strong></p>`;
    
        revealEl.innerHTML = html;
        
        // Show restart button for host
        if (isHost) {
          document.getElementById("restartGameBtn").classList.remove("hidden");
        } else {
          document.getElementById("restartGameBtn").classList.add("hidden");
        }
      } catch (error) {
        console.error("Error loading reveal:", error);
      }
    }
  </script>
</body>
</html> 
